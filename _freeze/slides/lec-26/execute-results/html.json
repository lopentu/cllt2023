{
  "hash": "9f7239b5ba06b0f694670293bee9d9db",
  "result": {
    "markdown": "---\ntitle: \"MultiLR: Predictive models (cont.)\"\nsubtitle: \"STA 210 - Spring 2022\"\nauthor: \"Dr. Mine Çetinkaya-Rundel\"\nfooter: \"[sta210-s22.github.io/website](https://sta210-s22.github.io/website/)\"\nlogo: \"images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    transition: fade\n    slide-number: true\n    incremental: true \n    chalkboard: true\n    highlight-style: ayu-mirage\ncode-link: true\neditor: visual\nexecute:\n  freeze: auto\n  echo: true\n---\n\n\n\n# Welcome\n\n## Topics\n\n::: nonincremental\n-   Unbalanced data\n-   Choosing the \"final\" model\n:::\n\n## Computational setup\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# load packages\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(knitr)\nlibrary(colorblindr)\nlibrary(themis)\n\n# set default theme and larger font size for ggplot2\nggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))\n```\n:::\n\n# From last time...\n\n## Volcanoes\n\nThe data come from [The Smithsonian Institution](https://volcano.si.edu/), via [TidyTuesday](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md).\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano <- read_csv(here::here(\"slides\", \"data/volcano.csv\"))\nnames(volcano)\n```\n\n::: {.cell-output-stdout}\n```\n [1] \"volcano_number\"           \"volcano_name\"            \n [3] \"primary_volcano_type\"     \"last_eruption_year\"      \n [5] \"country\"                  \"region\"                  \n [7] \"subregion\"                \"latitude\"                \n [9] \"longitude\"                \"elevation\"               \n[11] \"tectonic_settings\"        \"evidence_category\"       \n[13] \"major_rock_1\"             \"major_rock_2\"            \n[15] \"major_rock_3\"             \"major_rock_4\"            \n[17] \"major_rock_5\"             \"minor_rock_1\"            \n[19] \"minor_rock_2\"             \"minor_rock_3\"            \n[21] \"minor_rock_4\"             \"minor_rock_5\"            \n[23] \"population_within_5_km\"   \"population_within_10_km\" \n[25] \"population_within_30_km\"  \"population_within_100_km\"\n```\n:::\n:::\n\n## Data prep\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano <- volcano %>%\n  mutate(\n    volcano_type = case_when(\n      str_detect(primary_volcano_type, \"Stratovolcano\") ~ \"Stratovolcano\",\n      str_detect(primary_volcano_type, \"Shield\") ~ \"Shield\",\n      TRUE ~ \"Other\"\n    ),\n    volcano_type = fct_relevel(volcano_type, \"Stratovolcano\", \"Shield\", \"Other\")\n  ) %>%\n  select(\n    volcano_type, latitude, longitude, \n    elevation, tectonic_settings, major_rock_1\n    ) %>%\n  mutate(across(where(is.character), as_factor))\n```\n:::\n\n## Split into testing/training\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(1234)\n\nvolcano_split <- initial_split(volcano)\nvolcano_train <- training(volcano_split)\nvolcano_test  <- testing(volcano_split)\n```\n:::\n\n## Specify a model\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_spec <- multinom_reg() %>%\n  set_engine(\"nnet\")\n\nvolcano_spec\n```\n\n::: {.cell-output-stdout}\n```\nMultinomial Regression Model Specification (classification)\n\nComputational engine: nnet \n```\n:::\n:::\n\n## Create cross validation folds\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(9876)\n\nvolcano_folds <- vfold_cv(volcano_train, v = 5)\nvolcano_folds\n```\n\n::: {.cell-output-stdout}\n```\n#  5-fold cross-validation \n# A tibble: 5 × 2\n  splits            id   \n  <list>            <chr>\n1 <split [574/144]> Fold1\n2 <split [574/144]> Fold2\n3 <split [574/144]> Fold3\n4 <split [575/143]> Fold4\n5 <split [575/143]> Fold5\n```\n:::\n:::\n\n# Unbalanced data\n\n## Unbalanced data\n\nRemember that the observed volcano types are unbalanced:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano %>% \n  count(volcano_type)\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 3 × 2\n  volcano_type      n\n  <fct>         <int>\n1 Stratovolcano   461\n2 Shield          118\n3 Other           379\n```\n:::\n:::\n\n## Addressing unbalance {.smaller}\n\nTo address class unbalance, we generally use\n\n-   **oversampling** data from levels that are less prevalent in the data\n    -   e.g., `step_smote()`: Uses a technique called [\"**S**ynthetic **M**inority **O**ver-sampling **Te**chnique\"](https://jair.org/index.php/jair/article/view/10302/24590) to generate new examples of the minority class using nearest neighbors of these cases.\n-   **downsampling** data from levels that are more prevalent in the data\n    -   e.g., `step_downsample()`: Removes rows of a data set to make the occurrence of levels in a specific factor level equal.\n\n## New recipe - oversample\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|7\"}\nvolcano_rec3 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors()) %>%\n  step_smote(volcano_type)\n```\n:::\n\n## New recipe - downsample\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|7\"}\nvolcano_rec4 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors()) %>%\n  step_downsample(volcano_type)\n```\n:::\n\n## New workflows\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_wflow3 <- workflow() %>%\n  add_recipe(volcano_rec3) %>%\n  add_model(volcano_spec)\n\nvolcano_wflow4 <- workflow() %>%\n  add_recipe(volcano_rec4) %>%\n  add_model(volcano_spec)\n```\n:::\n\n## Fit resamples\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_fit_rs3 <- volcano_wflow3 %>%\n  fit_resamples(\n    volcano_folds, \n    control = control_resamples(save_pred = TRUE)\n    )\n\nvolcano_fit_rs4 <- volcano_wflow4 %>%\n  fit_resamples(\n    volcano_folds, \n    control = control_resamples(save_pred = TRUE)\n    )\n```\n:::\n\n## Collect metrics\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_metrics(volcano_fit_rs3)\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 2 × 6\n  .metric  .estimator  mean     n std_err .config             \n  <chr>    <chr>      <dbl> <int>   <dbl> <chr>               \n1 accuracy multiclass 0.517     5  0.0154 Preprocessor1_Model1\n2 roc_auc  hand_till  0.693     5  0.0270 Preprocessor1_Model1\n```\n:::\n\n```{.r .cell-code}\ncollect_metrics(volcano_fit_rs4)\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 2 × 6\n  .metric  .estimator  mean     n std_err .config             \n  <chr>    <chr>      <dbl> <int>   <dbl> <chr>               \n1 accuracy multiclass 0.485     5  0.0123 Preprocessor1_Model1\n2 roc_auc  hand_till  0.675     5  0.0219 Preprocessor1_Model1\n```\n:::\n:::\n\n## ROC curves - oversampling\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_fit_rs3 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  ) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-26_files/figure-revealjs/unnamed-chunk-14-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## ROC curves - downsampling\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_fit_rs4 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  ) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-26_files/figure-revealjs/unnamed-chunk-15-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## Addressing unbalance\n\n::: question\nCan you think of any issues resulting from over/down sampling?\n:::\n\n# Final model\n\n## The \"chosen\" model\n\nLet's stick to the models without over/down sampling.\n\nFrom the application exercise:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_rec2 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors())\n\nvolcano_wflow2 <- workflow() %>%\n  add_recipe(volcano_rec2) %>%\n  add_model(volcano_spec)\n```\n:::\n\n## Fitting the final model\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|1-4|6\"}\nfinal_fit <- last_fit(\n  volcano_wflow2, \n  split = volcano_split\n  )\n\ncollect_metrics(final_fit)\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 2 × 4\n  .metric  .estimator .estimate .config             \n  <chr>    <chr>          <dbl> <chr>               \n1 accuracy multiclass     0.629 Preprocessor1_Model1\n2 roc_auc  hand_till      0.734 Preprocessor1_Model1\n```\n:::\n:::\n\n## Confusion matrix\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_predictions(final_fit) %>%\n  conf_mat(volcano_type, .pred_class)\n```\n\n::: {.cell-output-stdout}\n```\n               Truth\nPrediction      Stratovolcano Shield Other\n  Stratovolcano            96     13    38\n  Shield                    1      0     0\n  Other                    21     16    55\n```\n:::\n:::\n\n## Confusion matrix - visualized\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_predictions(final_fit) %>%\n  conf_mat(volcano_type, .pred_class) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-26_files/figure-revealjs/unnamed-chunk-19-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## ROC curve\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_predictions(final_fit) %>%\n  roc_curve(truth = volcano_type, .pred_Stratovolcano:.pred_Other) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-26_files/figure-revealjs/unnamed-chunk-20-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## ROC curve - altogether\n\n::: appex\n📋 [github.com/sta210-s22/ae-11-volcanoes](https://github.com/sta210-s22/ae-11-volcanoes) - Exercise 3\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](lec-26_files/figure-revealjs/unnamed-chunk-21-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## Prediction\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfinal_fitted <- extract_workflow(final_fit)\n\nnew_volcano <- tibble(\n  latitude = 35.9940,\n  longitude = -78.8986,\n  elevation = 404,\n  tectonic_settings = \"Subduction zone / Continental crust (>25 km)\",\n  major_rock_1 = \"Andesite / Basaltic Andesite\"\n)\n\npredict(\n  final_fitted, \n  new_volcano, \n  type = \"prob\"\n  )\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 3 × 1\n  .pred_value\n        <dbl>\n1      0.381 \n2      0.0379\n3      0.581 \n```\n:::\n:::\n\n## Acknowledgements\n\nInspired by\n\n::: nonincremental\n-   https://juliasilge.com/blog/multinomial-volcano-eruptions/\n-   https://juliasilge.com/blog/nber-papers/\n:::",
    "supporting": [
      "lec-26_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    function fireSlideChanged(previousSlide, currentSlide) {\n\n      // dispatch for htmlwidgets\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for reveal\n    if (window.Reveal) {\n      window.Reveal.addEventListener(\"slidechanged\", function(event) {\n        fireSlideChanged(event.previousSlide, event.currentSlide);\n      });\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}