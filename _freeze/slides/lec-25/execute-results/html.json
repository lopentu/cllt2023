{
  "hash": "34c5d88c8ba6c39f2b3d6f950b0d436a",
  "result": {
    "markdown": "---\ntitle: \"MultiLR: Predictive models\"\nsubtitle: \"STA 210 - Spring 2022\"\nauthor: \"Dr. Mine Çetinkaya-Rundel\"\nfooter: \"[sta210-s22.github.io/website](https://sta210-s22.github.io/website/)\"\nlogo: \"images/logo.png\"\nformat: \n  revealjs:\n    theme: slides.scss\n    transition: fade\n    slide-number: true\n    incremental: true \n    chalkboard: true\n    highlight-style: ayu-mirage\ncode-link: true\neditor: visual\nexecute:\n  freeze: auto\n  echo: true\n---\n\n\n\n# Welcome\n\n## Topics\n\n::: nonincremental\n-   Building predictive multinomial logistic regression models\n-   Comparing models\n:::\n\n## Computational setup\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# load packages\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(knitr)\nlibrary(colorblindr)\nlibrary(themis)\n\n# set default theme and larger font size for ggplot2\nggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))\n```\n:::\n\n## Terminology\n\n::: question\nWhat's the difference between regression and classification?\n\n::: nonincremental\n-   Logistic regression / binary classification\n-   Multinomial logistic regression / multinomial classification\n:::\n:::\n\n# Data\n\n## Volcanoes\n\nThe data come from [The Smithsonian Institution](https://volcano.si.edu/), via [TidyTuesday](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md).\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano <- read_csv(here::here(\"slides\", \"data/volcano.csv\"))\nnames(volcano)\n```\n\n::: {.cell-output-stdout}\n```\n [1] \"volcano_number\"           \"volcano_name\"            \n [3] \"primary_volcano_type\"     \"last_eruption_year\"      \n [5] \"country\"                  \"region\"                  \n [7] \"subregion\"                \"latitude\"                \n [9] \"longitude\"                \"elevation\"               \n[11] \"tectonic_settings\"        \"evidence_category\"       \n[13] \"major_rock_1\"             \"major_rock_2\"            \n[15] \"major_rock_3\"             \"major_rock_4\"            \n[17] \"major_rock_5\"             \"minor_rock_1\"            \n[19] \"minor_rock_2\"             \"minor_rock_3\"            \n[21] \"minor_rock_4\"             \"minor_rock_5\"            \n[23] \"population_within_5_km\"   \"population_within_10_km\" \n[25] \"population_within_30_km\"  \"population_within_100_km\"\n```\n:::\n:::\n\n## Volcanoes {.smaller}\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nglimpse(volcano)\n```\n\n::: {.cell-output-stdout}\n```\nRows: 958\nColumns: 26\n$ volcano_number           <dbl> 283001, 355096, 342080, 213004, 321040, 28317…\n$ volcano_name             <chr> \"Abu\", \"Acamarachi\", \"Acatenango\", \"Acigol-Ne…\n$ primary_volcano_type     <chr> \"Shield(s)\", \"Stratovolcano\", \"Stratovolcano(…\n$ last_eruption_year       <chr> \"-6850\", \"Unknown\", \"1972\", \"-2080\", \"950\", \"…\n$ country                  <chr> \"Japan\", \"Chile\", \"Guatemala\", \"Turkey\", \"Uni…\n$ region                   <chr> \"Japan, Taiwan, Marianas\", \"South America\", \"…\n$ subregion                <chr> \"Honshu\", \"Northern Chile, Bolivia and Argent…\n$ latitude                 <dbl> 34.500, -23.292, 14.501, 38.537, 46.206, 37.6…\n$ longitude                <dbl> 131.600, -67.618, -90.876, 34.621, -121.490, …\n$ elevation                <dbl> 641, 6023, 3976, 1683, 3742, 1728, 1733, 1250…\n$ tectonic_settings        <chr> \"Subduction zone / Continental crust (>25 km)…\n$ evidence_category        <chr> \"Eruption Dated\", \"Evidence Credible\", \"Erupt…\n$ major_rock_1             <chr> \"Andesite / Basaltic Andesite\", \"Dacite\", \"An…\n$ major_rock_2             <chr> \"Basalt / Picro-Basalt\", \"Andesite / Basaltic…\n$ major_rock_3             <chr> \"Dacite\", \" \", \" \", \"Basalt / Picro-Basalt\", …\n$ major_rock_4             <chr> \" \", \" \", \" \", \"Andesite / Basaltic Andesite\"…\n$ major_rock_5             <chr> \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", …\n$ minor_rock_1             <chr> \" \", \" \", \"Basalt / Picro-Basalt\", \" \", \"Daci…\n$ minor_rock_2             <chr> \" \", \" \", \" \", \" \", \" \", \"Basalt / Picro-Basa…\n$ minor_rock_3             <chr> \" \", \" \", \" \", \" \", \" \", \" \", \" \", \"Andesite …\n$ minor_rock_4             <chr> \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", …\n$ minor_rock_5             <chr> \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", \" \", …\n$ population_within_5_km   <dbl> 3597, 0, 4329, 127863, 0, 428, 101, 51, 0, 98…\n$ population_within_10_km  <dbl> 9594, 7, 60730, 127863, 70, 3936, 485, 6042, …\n$ population_within_30_km  <dbl> 117805, 294, 1042836, 218469, 4019, 717078, 1…\n$ population_within_100_km <dbl> 4071152, 9092, 7634778, 2253483, 393303, 5024…\n```\n:::\n:::\n\n## Types of volcanoes {.smaller}\n\nProbably too many types!\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano %>%\n  count(primary_volcano_type, sort = TRUE) %>%\n  print(n = 26)\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 26 × 2\n   primary_volcano_type     n\n   <chr>                <int>\n 1 Stratovolcano          353\n 2 Stratovolcano(es)      107\n 3 Shield                  85\n 4 Volcanic field          71\n 5 Pyroclastic cone(s)     70\n 6 Caldera                 65\n 7 Complex                 46\n 8 Shield(s)               33\n 9 Submarine               27\n10 Lava dome(s)            26\n11 Fissure vent(s)         12\n12 Caldera(s)               9\n13 Compound                 9\n14 Maar(s)                  8\n15 Pyroclastic shield       7\n16 Tuff cone(s)             7\n17 Crater rows              5\n18 Subglacial               5\n19 Pyroclastic cone         4\n20 Lava dome                3\n21 Complex(es)              1\n22 Lava cone                1\n23 Lava cone(es)            1\n24 Lava cone(s)             1\n25 Stratovolcano?           1\n26 Tuff cone                1\n```\n:::\n:::\n\n## Relevel volcanoes\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano <- volcano %>%\n  mutate(\n    volcano_type = case_when(\n      str_detect(primary_volcano_type, \"Stratovolcano\") ~ \"Stratovolcano\",\n      str_detect(primary_volcano_type, \"Shield\") ~ \"Shield\",\n      TRUE ~ \"Other\"\n    ),\n    volcano_type = fct_relevel(volcano_type, \"Stratovolcano\", \"Shield\", \"Other\")\n  )\n\nvolcano %>%\n  count(volcano_type)\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 3 × 2\n  volcano_type      n\n  <fct>         <int>\n1 Stratovolcano   461\n2 Shield          118\n3 Other           379\n```\n:::\n:::\n\n## Data prep\n\n-   Select a few variables as predictors for the model with\n-   Convert all character variables to factors\n\n. . .\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano <- volcano %>%\n  select(\n    volcano_type, latitude, longitude, \n    elevation, tectonic_settings, major_rock_1\n    ) %>%\n  mutate(across(where(is.character), as_factor))\n```\n:::\n\n## Mapping the volcanoes\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## World map data\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nworld <- map_data(\"world\")\n\nworld %>% as_tibble()\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 99,338 × 6\n    long   lat group order region subregion\n   <dbl> <dbl> <dbl> <int> <chr>  <chr>    \n 1 -69.9  12.5     1     1 Aruba  <NA>     \n 2 -69.9  12.4     1     2 Aruba  <NA>     \n 3 -69.9  12.4     1     3 Aruba  <NA>     \n 4 -70.0  12.5     1     4 Aruba  <NA>     \n 5 -70.1  12.5     1     5 Aruba  <NA>     \n 6 -70.1  12.6     1     6 Aruba  <NA>     \n 7 -70.0  12.6     1     7 Aruba  <NA>     \n 8 -70.0  12.6     1     8 Aruba  <NA>     \n 9 -69.9  12.5     1     9 Aruba  <NA>     \n10 -69.9  12.5     1    10 Aruba  <NA>     \n# … with 99,328 more rows\n```\n:::\n:::\n\n## Draw world map\n\n::: {.cell layout-align=\"center\" output-location='column-fragment'}\n\n```{.r .cell-code}\nworld_map <- ggplot() +\n  geom_polygon(\n    data = world, \n    aes(\n      x = long, y = lat, group = group),\n      color = \"white\", fill = \"gray50\", \n      size = 0.05, alpha = 0.2\n    ) +\n  theme_minimal() +\n  coord_quickmap() +\n  labs(x = NULL, y = NULL)\n\nworld_map\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-10-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## Add volcanoes\n\n::: {.cell layout-align=\"center\" output-location='column-fragment'}\n\n```{.r .cell-code}\nworld_map +\n  geom_point(\n    data = volcano,\n    aes(\n      x = longitude, y = latitude, \n      color = volcano_type, \n      shape = volcano_type),\n    alpha = 0.5\n  ) +\n  scale_color_OkabeIto() +\n  labs(color = NULL, shape = NULL)\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-11-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## Your turn\n\n::: appex\n📋 [github.com/sta210-s22/ae-11-volcanoes](https://github.com/sta210-s22/ae-11-volcanoes) - Exercise 1\n:::\n\n# Build a model\n\n## Split into testing/training\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(1234)\n\nvolcano_split <- initial_split(volcano)\nvolcano_train <- training(volcano_split)\nvolcano_test  <- testing(volcano_split)\n```\n:::\n\n## Create a recipe\n\nStart with a model that doesn't use geographic information:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|2|3,4|5|6|7\"}\nvolcano_rec1 <- recipe(volcano_type ~ ., data = volcano_train) %>%\n  step_rm(latitude, longitude) %>%\n  step_other(tectonic_settings) %>%\n  step_other(major_rock_1) %>%\n  step_dummy(all_nominal_predictors()) %>%\n  step_zv(all_predictors()) %>%\n  step_center(all_predictors())\n```\n:::\n\n## Specify a model\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_spec <- multinom_reg() %>%\n  set_engine(\"nnet\")\n\nvolcano_spec\n```\n\n::: {.cell-output-stdout}\n```\nMultinomial Regression Model Specification (classification)\n\nComputational engine: nnet \n```\n:::\n:::\n\n## Create a workflow\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|1|2|3\"}\nvolcano_wflow1 <- workflow() %>%\n  add_recipe(volcano_rec1) %>%\n  add_model(volcano_spec)\n\nvolcano_wflow1\n```\n\n::: {.cell-output-stdout}\n```\n══ Workflow ════════════════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: multinom_reg()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n6 Recipe Steps\n\n• step_rm()\n• step_other()\n• step_other()\n• step_dummy()\n• step_zv()\n• step_center()\n\n── Model ───────────────────────────────────────────────────────────────────────\nMultinomial Regression Model Specification (classification)\n\nComputational engine: nnet \n```\n:::\n:::\n\n## Create cross validation folds\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(9876)\n\nvolcano_folds <- vfold_cv(volcano_train, v = 5)\nvolcano_folds\n```\n\n::: {.cell-output-stdout}\n```\n#  5-fold cross-validation \n# A tibble: 5 × 2\n  splits            id   \n  <list>            <chr>\n1 <split [574/144]> Fold1\n2 <split [574/144]> Fold2\n3 <split [574/144]> Fold3\n4 <split [575/143]> Fold4\n5 <split [575/143]> Fold5\n```\n:::\n:::\n\n## Fit resamples\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"|1|2-5\"}\nvolcano_fit_rs1 <- volcano_wflow1 %>%\n  fit_resamples(\n    volcano_folds, \n    control = control_resamples(save_pred = TRUE)\n    )\n\nvolcano_fit_rs1\n```\n\n::: {.cell-output-stdout}\n```\n# Resampling results\n# 5-fold cross-validation \n# A tibble: 5 × 5\n  splits            id    .metrics         .notes           .predictions      \n  <list>            <chr> <list>           <list>           <list>            \n1 <split [574/144]> Fold1 <tibble [2 × 4]> <tibble [0 × 1]> <tibble [144 × 7]>\n2 <split [574/144]> Fold2 <tibble [2 × 4]> <tibble [0 × 1]> <tibble [144 × 7]>\n3 <split [574/144]> Fold3 <tibble [2 × 4]> <tibble [0 × 1]> <tibble [144 × 7]>\n4 <split [575/143]> Fold4 <tibble [2 × 4]> <tibble [0 × 1]> <tibble [143 × 7]>\n5 <split [575/143]> Fold5 <tibble [2 × 4]> <tibble [0 × 1]> <tibble [143 × 7]>\n```\n:::\n:::\n\n## Collect metrics\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncollect_metrics(volcano_fit_rs1)\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 2 × 6\n  .metric  .estimator  mean     n std_err .config             \n  <chr>    <chr>      <dbl> <int>   <dbl> <chr>               \n1 accuracy multiclass 0.596     5  0.0146 Preprocessor1_Model1\n2 roc_auc  hand_till  0.703     5  0.0244 Preprocessor1_Model1\n```\n:::\n:::\n\n## ROC curve\n\nROC curves for multiclass outcomes use a one-vs-all approach: calculate multiple curves, one per level vs. all other levels.\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code}\nvolcano_fit_rs1 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  ) %>%\n  autoplot()\n```\n\n::: {.cell-output-display}\n![](lec-25_files/figure-revealjs/unnamed-chunk-19-1.png){fig-align='center' width=90%}\n:::\n:::\n\n## ROC curve - under the hood\n\nAn additional column, `.level`, identifies the \"one\" column in the one-vs-all calculation:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvolcano_fit_rs1 %>%\n  collect_predictions() %>%\n  group_by(id) %>%\n  roc_curve(\n    truth = volcano_type,\n    .pred_Stratovolcano:.pred_Other\n  )\n```\n\n::: {.cell-output-stdout}\n```\n# A tibble: 2,175 × 5\n# Groups:   id [5]\n   id    .level        .threshold specificity sensitivity\n   <chr> <chr>              <dbl>       <dbl>       <dbl>\n 1 Fold1 Stratovolcano  -Inf           0                1\n 2 Fold1 Stratovolcano     0.0621      0                1\n 3 Fold1 Stratovolcano     0.0786      0.0123           1\n 4 Fold1 Stratovolcano     0.0869      0.0247           1\n 5 Fold1 Stratovolcano     0.0957      0.0370           1\n 6 Fold1 Stratovolcano     0.104       0.0494           1\n 7 Fold1 Stratovolcano     0.104       0.0617           1\n 8 Fold1 Stratovolcano     0.105       0.0741           1\n 9 Fold1 Stratovolcano     0.105       0.0864           1\n10 Fold1 Stratovolcano     0.107       0.0988           1\n# … with 2,165 more rows\n```\n:::\n:::\n\n# Build another model\n\n## Your turn\n\n::: appex\n📋 [github.com/sta210-s22/ae-11-volcanoes](https://github.com/sta210-s22/ae-11-volcanoes) - Exercise 2\n:::\n\n## Acknowledgements\n\nInspired by\n\n::: nonincremental\n-   https://juliasilge.com/blog/multinomial-volcano-eruptions/\n-   https://juliasilge.com/blog/nber-papers/\n:::",
    "supporting": [
      "lec-25_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    function fireSlideChanged(previousSlide, currentSlide) {\n\n      // dispatch for htmlwidgets\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for reveal\n    if (window.Reveal) {\n      window.Reveal.addEventListener(\"slidechanged\", function(event) {\n        fireSlideChanged(event.previousSlide, event.currentSlide);\n      });\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}